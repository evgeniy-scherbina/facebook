---
- name: Set kube_user variable
  set_fact:
    kube_user: "ubuntu"

- name: Get user home directory
  shell: echo ~{{ kube_user }}
  register: user_home_result
  changed_when: false

- name: Get AWS region from instance metadata
  shell: curl -s http://169.254.169.254/latest/meta-data/placement/region
  register: aws_region_infra
  changed_when: false

- name: Get node subnet ID from SSM (same subnet as EC2 nodes; CLB will use this)
  shell: |
    aws ssm get-parameter --name "/facebook-chat/node-subnet-id" --region {{ aws_region_infra.stdout }} --query 'Parameter.Value' --output text
  register: node_subnet_id_result
  changed_when: false
  failed_when: false

- name: Check if Ingress Controller namespace exists
  command: kubectl get namespace ingress-nginx
  register: ingress_namespace_check
  changed_when: false
  failed_when: false
  become: yes
  become_user: "{{ kube_user }}"
  environment:
    KUBECONFIG: "{{ user_home_result.stdout }}/.kube/config"

# Annotation must be present when Service is first created so CCM creates CLB in the right subnet.
# Patching after apply is too late: CCM already creates the CLB with default subnets.
- name: Copy deploy manifest to temp file for annotation injection
  copy:
    src: "{{ user_home_result.stdout }}/facebook/k8s/infrastructure/ingress-nginx/deploy.yaml"
    dest: /tmp/ingress-nginx-deploy.yaml
    remote_src: yes
  become: yes
  become_user: "{{ kube_user }}"

# Match only the LoadBalancer Service (has externalTrafficPolicy after spec:), not the Deployment (has minReadySeconds)
- name: Inject CLB subnet annotation into Service before first apply
  replace:
    path: /tmp/ingress-nginx-deploy.yaml
    regexp: '  name: ingress-nginx-controller\n  namespace: ingress-nginx\nspec:\n  externalTrafficPolicy'
    replace: '  name: ingress-nginx-controller\n  namespace: ingress-nginx\n  annotations:\n    service.beta.kubernetes.io/aws-load-balancer-subnets: "{{ node_subnet_id_result.stdout | trim }}"\nspec:\n  externalTrafficPolicy'
  become: yes
  when: node_subnet_id_result.stdout | length > 0

- name: Install NGINX Ingress Controller (with subnet annotation so CLB gets targets)
  command: kubectl apply -f /tmp/ingress-nginx-deploy.yaml
  become: yes
  become_user: "{{ kube_user }}"
  environment:
    KUBECONFIG: "{{ user_home_result.stdout }}/.kube/config"
  register: ingress_install_result
  changed_when: "'created' in ingress_install_result.stdout or 'configured' in ingress_install_result.stdout"
  when: node_subnet_id_result.stdout | length > 0

- name: Install NGINX Ingress Controller (no subnet from SSM, use raw manifest)
  command: kubectl apply -f {{ user_home_result.stdout }}/facebook/k8s/infrastructure/ingress-nginx/deploy.yaml
  become: yes
  become_user: "{{ kube_user }}"
  environment:
    KUBECONFIG: "{{ user_home_result.stdout }}/.kube/config"
  register: ingress_install_result
  when: node_subnet_id_result.stdout | length == 0

- name: Wait for Ingress Controller to be ready
  command: >
    kubectl wait --namespace ingress-nginx
    --for=condition=ready pod
    --selector=app.kubernetes.io/component=controller
    --timeout=300s
  become: yes
  become_user: "{{ kube_user }}"
  environment:
    KUBECONFIG: "{{ user_home_result.stdout }}/.kube/config"
  register: ingress_wait_result
  changed_when: false
  # Don't fail if timeout - controller might still be starting
  ignore_errors: true

- name: Display Ingress Controller status
  command: kubectl get pods -n ingress-nginx
  become: yes
  become_user: "{{ kube_user }}"
  environment:
    KUBECONFIG: "{{ user_home_result.stdout }}/.kube/config"
  register: ingress_pods
  changed_when: false

- name: Display Ingress Controller service
  command: kubectl get svc -n ingress-nginx ingress-nginx-controller
  become: yes
  become_user: "{{ kube_user }}"
  environment:
    KUBECONFIG: "{{ user_home_result.stdout }}/.kube/config"
  register: ingress_svc
  changed_when: false

- name: Show Ingress Controller installation summary
  debug:
    msg:
      - "Ingress Controller installation completed"
      - "Pods: {{ ingress_pods.stdout_lines }}"
      - "Service: {{ ingress_svc.stdout_lines }}"
      - "To get external IP: kubectl get svc -n ingress-nginx ingress-nginx-controller"

